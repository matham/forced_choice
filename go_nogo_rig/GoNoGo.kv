#:kivy 1.8.1
#:import clock time.clock


<RootStage>:
    name: 'Root_stage'
    completion_list: self.stages
    on_finished:
        if self.finished: barst.request_callback('stop_devices', lambda *l: setattr(app, 'app_state', 'clear'))
        app.exp_status = 0
    on_started: app.exp_status = 0
    InitBarstStage:
        id: barst
        name: 'barst'
        on_started: if self.started: app.exp_status = 1
    AnimalStage:
        name: 'rat_loop'
        repeat: -1
        id: animal_stage
        block: block
        verify: verify
        trial: trial
        animal_id: app.animal_pause_btn.button.animal_id
        on_parent: app.animal_stage = self
        DigitalGateStage:
            name: 'rat_wait'
            device: app.animal_pause_btn
            exit_state: True
            on_started: if self.started: app.exp_status = 2
            on_finished: if self.finished: animal_stage.pre_animal()
        VerifyConfigStage:
            id: verify
            on_parent: app.verify_stage = self
            on_finished: if self.finished: animal_stage.post_verify()
        MoaStage:
            name: 'block'
            id: block
            repeat: verify.num_blocks
            on_finished: if self.finished: animal_stage.post_block()
            in_purgotory: not self.started or self.finished
            MoaStage:
                name: 'trials'
                id: trial
                repeat: verify.num_trials[block.count]
                on_started: if self.started: animal_stage.pre_block()
                in_purgotory: not self.started or self.finished or block.in_purgotory
                DigitalGateStage:
                    name: 'house_light_on'
                    device: app.daq_out_dev
                    exit_state: True
                    state_attr: 'house_light'
                    on_started:
                        if self.started: animal_stage.pre_trial()
                        if self.started and app.daq_out_dev: app.daq_out_dev.set_state(high=['house_light'])
                        if self.started and app.pin_dev: app.pin_dev.set_state(high=['pump'])
                DigitalGateStage:
                    name: 'nose_poke_wait'
                    device: app.daq_in_dev
                    exit_state: True
                    state_attr: 'nose_beam'
                    on_started: if self.started: app.exp_status = 3
                    on_finished: if self.finished: animal_stage.outcome.nose_poke_ts = clock()
                DigitalGateStage:
                    name: 'odor_start'
                    device: app.odor_dev
                    exit_state: True
                    state_attr: str(verify.odor_NO[block.count])
                    on_started:
                        if self.started and app.odor_dev: app.odor_dev.set_state(high=[verify.odor_NO[block.count], verify.trial_odors[block.count][trial.count]])
                DigitalGateStage:
                    name: 'wait_nose_poke_exit'
                    device: app.daq_in_dev
                    exit_state: False
                    state_attr: 'nose_beam'
                    max_duration: verify.max_nose_poke[block.count]
                    on_finished:
                        if self.finished and app.odor_dev: app.odor_dev.set_state(low=[verify.odor_NO[block.count], verify.trial_odors[block.count][trial.count]])
                        if self.finished and not app.daq_in_dev.nose_beam: animal_stage.outcome.nose_poke_exit_ts = clock()
                    on_started: if self.started: app.exp_status = 4
                DigitalGateStage:
                    name: 'decision_stage'
                    device: app.daq_in_dev
                    exit_state: True
                    state_attr: 'reward_beam_r'
                    max_duration: verify.decision_duration[block.count]
                    on_finished: if self.finished: animal_stage.do_decision(self.timed_out)
                    on_started: if self.started: app.exp_status = 5
                Delay:
                    disabled: (not verify.reward[block.count][trial.count]) if not trial.in_purgotory else False
                    name: 'reward_stage'
                    delay: .1
                    on_finished: if self.finished and app.pin_dev: app.pin_dev.set_state(low=['pump'])
                Delay:
                    name: 'iti'
                    delay: verify.iti[block.count][trial.count] if not trial.in_purgotory else 0
                    on_started: if self.started and app.daq_out_dev: app.daq_out_dev.set_state(low=['house_light'])
                    on_started: if self.started: app.exp_status = 6
                    on_finished: if self.finished: animal_stage.post_trial()
